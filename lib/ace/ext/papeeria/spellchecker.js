// Generated by CoffeeScript 1.10.0
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  define(function() {
    var PopupManager, SpellChecker, TEST_JSON_TYPOS, convertCorrectionList, extractWord, getCurrentWordRange, setupSpellCheckerPopup;
    TEST_JSON_TYPOS = {
      "blablabla": ["blah-blah-blah", "blabber", "blabbed", "salable"]
    };
    SpellChecker = (function() {
      function SpellChecker() {
        this.check = bind(this.check, this);
      }

      SpellChecker.prototype.getJson = function() {
        return TEST_JSON_TYPOS;
      };

      SpellChecker.prototype.check = function(token) {
        return !this.getJson()[token];
      };

      SpellChecker.prototype.getCorrections = function(token) {
        if (!this.check(token)) {
          return this.getJson()[token];
        }
      };

      return SpellChecker;

    })();
    setupSpellCheckerPopup = function(editor) {
      var newPopup;
      PopupManager.init(editor);
      newPopup = function() {
        var correctionsItem, spellChecker, word;
        word = extractWord(editor);
        spellChecker = new SpellChecker();
        correctionsItem = spellChecker.getCorrections(word);
        if (correctionsItem) {
          PopupManager.show(convertCorrectionList(correctionsItem));
        }
      };
      editor.commands.addCommand({
        name: "newPopup",
        bindKey: "Alt-Enter",
        exec: newPopup
      });
    };
    extractWord = function(editor) {
      var session, wordRange;
      session = editor.getSession();
      wordRange = getCurrentWordRange(editor);
      return session.getTextRange(wordRange);
    };
    getCurrentWordRange = function(editor) {
      var col, row, session;
      session = editor.getSession();
      row = editor.getCursorPosition().row;
      col = editor.getCursorPosition().column;
      return session.getWordRange(row, col);
    };
    convertCorrectionList = function(corrections) {
      var item;
      return (function() {
        var i, len, results;
        results = [];
        for (i = 0, len = corrections.length; i < len; i++) {
          item = corrections[i];
          results.push({
            caption: item,
            value: item
          });
        }
        return results;
      })();
    };
    PopupManager = {
      commands: {
        "Esc": function() {
          return PopupManager.detach();
        },
        "Up": function() {
          return PopupManager.goTo("up");
        },
        "Down": function() {
          return PopupManager.goTo("down");
        },
        "Return": function() {
          return PopupManager.insertCorrection();
        }
      },
      init: function(editor) {
        var AcePopup, HashHandler;
        this.editor = editor;
        this.activated = false;
        HashHandler = require("ace/keyboard/hash_handler").HashHandler;
        AcePopup = require("ace/autocomplete/popup").AcePopup;
        this.popup = new AcePopup(document.body);
        this.popup.setTheme(editor.getTheme());
        this.popup.setFontSize(editor.getFontSize());
        this.popup.on("click", (function(_this) {
          return function(e) {
            _this.insertCorrection();
            return e.stop();
          };
        })(this));
        this.session = editor.getSession();
        this.keyboard = new HashHandler();
        this.keyboard.bindKeys(this.commands);
      },
      show: function(options) {
        var lineHeight, position, rect, renderer;
        this.options = options;
        this.popup.setData(options);
        this.activated = true;
        position = this.editor.getCursorPosition();
        this.base = this.session.doc.createAnchor(position.row, position.column);
        this.editor.keyBinding.addKeyboardHandler(this.keyboard);
        this.editor.on("change", function() {
          return PopupManager.detach();
        });
        this.editor.on("changeSelection", function() {
          return PopupManager.onChangeSelection();
        });
        this.editor.on("blur", function() {
          return PopupManager.detach();
        });
        this.editor.on("mousedown", function() {
          return PopupManager.detach();
        });
        this.editor.on("mousewheel", function() {
          return PopupManager.detach();
        });
        this.editor.$blockScrolling = Infinity;
        renderer = this.editor.renderer;
        lineHeight = renderer.layerConfig.lineHeight;
        position = renderer.$cursorLayer.getPixelPosition(this.base, true);
        position.left -= this.popup.getTextLeftOffset();
        rect = this.editor.container.getBoundingClientRect();
        position.top += rect.top - renderer.layerConfig.offset;
        position.left += rect.left - this.editor.renderer.scrollLeft;
        position.left += renderer.gutterWidth;
        this.popup.show(position, lineHeight);
      },
      detach: function() {
        if (!this.activated) {
          return;
        }
        this.popup.hide();
        this.base.detach();
        this.editor.keyBinding.removeKeyboardHandler(this.keyboard);
        this.editor.off("change", this.onChange);
        this.editor.off("changeSelection", this.onChangeSelection);
        this.editor.off("blur", this.onBlur);
        this.editor.off("mousedown", this.onMouseDown);
        this.editor.off("mousewheel", this.onMouseWheel);
        this.activated = false;
      },
      insertCorrection: function() {
        var correction, wordRange;
        this.detach();
        correction = this.getSelectedCorrection();
        wordRange = getCurrentWordRange(this.editor);
        this.editor.getSession().replace(wordRange, correction);
      },
      goTo: function(where) {
        var max, row;
        row = this.popup.getRow();
        max = this.popup.getSession().getLength() - 1;
        switch (where) {
          case "up":
            if (row <= 0) {
              row = max;
            } else {
              row = row - 1;
            }
            break;
          case "down":
            if (row >= max) {
              row = -1;
            } else {
              row = row + 1;
            }
        }
        this.popup.setRow(row);
      },
      getSelectedCorrection: function() {
        var row;
        row = this.popup.getRow();
        return this.options[row].value;
      },
      onChangeSelection: function(e) {
        var cursor;
        if (!this.activated) {
          this.detach();
          return;
        }
        cursor = this.editor.selection.lead;
        if (cursor.row !== this.base.row || cursor.column < this.base.column) {
          this.detach();
        }
      }
    };
    return {
      SpellChecker: SpellChecker,
      setupSpellCheckerPopup: setupSpellCheckerPopup
    };
  });

}).call(this);

//# sourceMappingURL=spellchecker.js.map
