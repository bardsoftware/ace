// Generated by CoffeeScript 1.11.1
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  define(function() {
    var STATE_COMPLETE, Spellchecker, getJson, mySpellchecker;
    STATE_COMPLETE = 4;
    getJson = function(url, data, onSuccess) {
      var xhr;
      xhr = new XMLHttpRequest();
      xhr.open("GET", url, true);
      xhr.onreadystatechange = function() {
        if (xhr.readyState === STATE_COMPLETE && xhr.status === 200) {
          return onSuccess(JSON.parse(xhr.responseText));
        }
      };
      return xhr.send(data);
    };
    Spellchecker = (function() {
      function Spellchecker(editor1) {
        this.editor = editor1;
        this.getCorrections = bind(this.getCorrections, this);
        this.check = bind(this.check, this);
        this.onSpellcheckingSessionUpdated = bind(this.onSpellcheckingSessionUpdated, this);
        this.onSettingsUpdated = bind(this.onSettingsUpdated, this);
        this._fetchTypos = bind(this._fetchTypos, this);
        this._init = bind(this._init, this);
        this._init(null);
      }

      Spellchecker.prototype._init = function(language) {
        this.language = language;
        this.typos = {};
        this.typosUrl = null;
        this.correctionsUrl = null;
        return this.typosHash = null;
      };

      Spellchecker.prototype._fetchTypos = function() {
        return getJson(this.typosUrl, null, (function(_this) {
          return function(typosArray) {
            var i, len, tmp, typo;
            tmp = {};
            for (i = 0, len = typosArray.length; i < len; i++) {
              typo = typosArray[i];
              tmp[typo] = true;
            }
            _this.typos = tmp;
            return _this.editor.getSession()._emit("updateSpellcheckingTypos", {
              typos: typosArray
            });
          };
        })(this));
      };

      Spellchecker.prototype.onSettingsUpdated = function(language) {
        return this._init(language);
      };

      Spellchecker.prototype.onSpellcheckingSessionUpdated = function(arg) {
        var suggestionsUrl, typosHash, typosUrl;
        typosHash = arg.typosHash, typosUrl = arg.typosUrl, suggestionsUrl = arg.suggestionsUrl;
        this.typosUrl = typosUrl;
        this.suggestionsUrl = suggestionsUrl;
        if (this.typosHash !== typosHash) {
          this.typosHash = typosHash;
          return this._fetchTypos();
        }
      };

      Spellchecker.prototype.check = function(token) {
        return !(token in this.typos);
      };

      Spellchecker.prototype.getCorrections = function(token, callback) {
        if (!this.check(token)) {
          return getJson(this.suggestionsUrl, {
            typo: token,
            language: this.language
          }, callback);
        }
      };

      return Spellchecker;

    })();
    mySpellchecker = null;
    return {
      getInstance: function() {
        if (mySpellchecker != null) {
          return mySpellchecker;
        } else {
          throw new Error("Spellchecker is not initialized");
        }
      },
      setup: function(editor) {
        return mySpellchecker = new Spellchecker(editor);
      }
    };
  });

}).call(this);
