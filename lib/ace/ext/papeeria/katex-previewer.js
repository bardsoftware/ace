// Generated by CoffeeScript 1.10.0
(function() {
  define(function(require, exports, module) {
    exports.setupPreviewer = function(editor, popoverHandler) {
      var callbackHidePopover, createPopover, initKaTeX, katex, renderFormulaToPopoverUnderCursor;
      katex = null;
      popoverHandler = popoverHandler != null ? popoverHandler : {
        options: {
          html: true,
          placement: "bottom",
          trigger: "manual",
          title: "Formula",
          container: editor.container
        },
        show: function(jqPopoverContainer, content, position) {
          jqPopoverContainer.css(position);
          popoverHandler.options.content = content;
          jqPopoverContainer.popover(popoverHandler.options);
          jqPopoverContainer.popover("show");
        },
        destroy: function(jqPopoverContainer) {
          return jqPopoverContainer.popover("destroy");
        },
        isVisible: function(jqPopoverContainer) {
          return jqPopoverContainer.data().popover.tip().hasClass("in");
        }
      };
      initKaTeX = function(onLoaded) {
        var cssDemoPath, linkDemo, span;
        cssDemoPath = require.toUrl("./katex-demo.css");
        linkDemo = $("<link>").attr({
          rel: "stylesheet",
          href: cssDemoPath
        });
        $("head").append(linkDemo);
        span = $("<span>").attr({
          id: "formula"
        });
        $("body").append(span);
        require(["ace/ext/katex"], function(katexInner) {
          katex = katexInner;
          onLoaded();
        });
      };
      callbackHidePopover = function() {
        popoverHandler.destroy($("#formula"));
        editor.off("changeSelection", callbackHidePopover);
        editor.session.off("changeScrollTop", callbackHidePopover);
        editor.session.off("changeScrollLeft", callbackHidePopover);
      };
      renderFormulaToPopoverUnderCursor = function() {
        var content, cursorPosition, e, error, popoverPosition;
        try {
          cursorPosition = $("textarea.ace_text-input").position();
          popoverPosition = {
            top: (cursorPosition.top + 24) + "px",
            left: cursorPosition.left + "px"
          };
          return content = katex.renderToString(editor.getSelectedText(), {
            displayMode: true
          });
        } catch (error) {
          e = error;
          return content = e;
        } finally {
          popoverHandler.show($("#formula"), content, popoverPosition);
          editor.on("changeSelection", callbackHidePopover);
          editor.session.on("changeScrollTop", callbackHidePopover);
          editor.session.on("changeScrollLeft", callbackHidePopover);
          return;
        }
      };
      createPopover = function(editor) {
        if (katex == null) {
          initKaTeX(renderFormulaToPopoverUnderCursor);
          return;
        }
        return renderFormulaToPopoverUnderCursor();
      };
      editor.commands.addCommand({
        name: "previewLaTeXFormula",
        bindKey: {
          win: "Alt-p",
          mac: "Alt-p"
        },
        exec: createPopover
      });
    };
  });

}).call(this);
