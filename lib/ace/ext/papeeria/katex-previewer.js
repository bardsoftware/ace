// Generated by CoffeeScript 1.10.0
(function() {
  define(function(require, exports, module) {
    exports.setupPreviewer = function(editor, popoverHandler) {
      var callback, callbackHidePopover, createPopover, destroyPopover, initKaTeX, katex, onLoaded;
      katex = null;
      popoverHandler = popoverHandler != null ? popoverHandler : {
        show: function(jqPopoverContainer, options) {
          var popoverPosition;
          jqPopoverContainer.css($("textarea.ace_text-input").position());
          popoverPosition = jqPopoverContainer.position();
          popoverPosition.top += 24;
          jqPopoverContainer.css(popoverPosition);
          jqPopoverContainer.popover(options);
          jqPopoverContainer.popover("show");
        },
        hide: function(jqPopoverContainer) {
          return jqPopoverContainer.popover("destroy");
        }
      };
      initKaTeX = function(onLoaded) {
        var a, cssDemoPath, linkDemo;
        cssDemoPath = require.toUrl("./katex-demo.css");
        linkDemo = $("<link>").attr({
          rel: "stylesheet",
          href: cssDemoPath
        });
        $("head").append(linkDemo);
        a = $("<a>").attr({
          href: "#",
          id: "formula",
          "data-toggle": "popover"
        });
        $("body").append(a);
        require(["ace/ext/katex"], function(katexInner) {
          katex = katexInner;
          onLoaded();
        });
      };
      onLoaded = function() {
        var e, error, options;
        options = {
          html: true,
          placement: "bottom",
          trigger: "manual",
          title: "Formula",
          container: "#editor"
        };
        try {
          return options.content = katex.renderToString(editor.getSelectedText(), {
            displayMode: true
          });
        } catch (error) {
          e = error;
          return options.content = e;
        } finally {
          popoverHandler.show($("#formula", options));
          return;
        }
      };
      callback = function(editor) {
        if ($("#editor > .popover").is(":visible")) {
          destroyPopover();
        } else {
          createPopover(editor);
        }
      };
      destroyPopover = function() {
        return popoverHandler.hide($("#formula"));
      };
      createPopover = function(editor) {
        if (katex == null) {
          initKaTeX(onLoaded);
          return;
        }
        return onLoaded();
      };
      editor.commands.addCommand({
        name: "previewLaTeXFormula",
        bindKey: {
          win: "Alt-p",
          mac: "Alt-p"
        },
        exec: callback
      });
    };
  });

}).call(this);
