// Generated by CoffeeScript 1.10.0
(function() {
  define(function(require, exports, module) {
    exports.setupPreviewer = function(editor, popoverHandler) {
      var initKaTeX, jqFormula, katex, selectionHandler;
      katex = null;
      popoverHandler = popoverHandler != null ? popoverHandler : {
        options: {
          html: true,
          placement: "bottom",
          trigger: "manual",
          title: "Formula",
          container: editor.container
        },
        show: function(jqPopoverContainer, content, position) {
          jqPopoverContainer.css(position);
          popoverHandler.options.content = content;
          jqPopoverContainer.popover(popoverHandler.options);
          jqPopoverContainer.popover("show");
        },
        destroy: function(jqPopoverContainer) {
          return jqPopoverContainer.popover("destroy");
        },
        isVisible: function(jqPopoverContainer) {
          return jqPopoverContainer.data().popover.tip().hasClass("in");
        },
        popoverExists: function(jqPopoverContainer) {
          return (jqPopoverContainer.data() != null) && (jqPopoverContainer.data().popover != null);
        },
        setContent: function(jqPopoverContainer, content) {
          var jqPopoverElement;
          jqPopoverElement = jqPopoverContainer.data().popover.tip().children(".popover-content");
          return jqPopoverElement.html(content);
        },
        setPosition: function(jqPopoverContainer, position) {
          var jqPopoverElement;
          jqPopoverElement = jqPopoverContainer.data().popover.tip();
          return jqPopoverElement.css(position);
        }
      };
      initKaTeX = function(onLoaded) {
        var cssDemoPath, linkDemo, span;
        cssDemoPath = require.toUrl("./katex-demo.css");
        linkDemo = $("<link>").attr({
          rel: "stylesheet",
          href: cssDemoPath
        });
        $("head").append(linkDemo);
        span = $("<span>").attr({
          id: "formula"
        });
        $("body").append(span);
        require(["ace/ext/katex"], function(katexInner) {
          katex = katexInner;
          onLoaded();
        });
      };
      jqFormula = function() {
        return $("#formula");
      };
      selectionHandler = {
        hideSelectionPopover: function() {
          popoverHandler.destroy(jqFormula());
          editor.off("changeSelection", selectionHandler.hideSelectionPopover);
          editor.session.off("changeScrollTop", selectionHandler.hideSelectionPopover);
          editor.session.off("changeScrollLeft", selectionHandler.hideSelectionPopover);
        },
        renderSelectionUnderCursor: function() {
          var content, cursorPosition, e, error, popoverPosition;
          try {
            cursorPosition = $("textarea.ace_text-input").position();
            popoverPosition = {
              top: (cursorPosition.top + 24) + "px",
              left: cursorPosition.left + "px"
            };
            return content = katex.renderToString(editor.getSelectedText(), {
              displayMode: true
            });
          } catch (error) {
            e = error;
            return content = e;
          } finally {
            popoverHandler.show(jqFormula(), content, popoverPosition);
            editor.on("changeSelection", selectionHandler.hideSelectionPopover);
            editor.session.on("changeScrollTop", selectionHandler.hideSelectionPopover);
            editor.session.on("changeScrollLeft", selectionHandler.hideSelectionPopover);
            return;
          }
        },
        createPopover: function(editor) {
          if (katex == null) {
            initKaTeX(selectionHandler.renderSelectionUnderCursor);
            return;
          }
          return selectionHandler.renderSelectionUnderCursor();
        }
      };
      editor.commands.addCommand({
        name: "previewLaTeXFormula",
        bindKey: {
          win: "Alt-p",
          mac: "Alt-p"
        },
        exec: selectionHandler.createPopover
      });
    };
  });

}).call(this);
