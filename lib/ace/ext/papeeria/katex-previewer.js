// Generated by CoffeeScript 1.10.0
(function() {
  define(function(require, exports, module) {
    var LatexParsingContext;
    LatexParsingContext = require("ace/ext/papeeria/latex_parsing_context");
    exports.setupPreviewer = function(editor, popoverHandler) {
      var ContextHandler, EquationRangeHandler, KATEX_OPTIONS, Range, SelectionHandler, TokenIterator, ch, erh, getFormulaElement, initKaTeX, jqEditorContainer, katex, sh;
      katex = null;
      if (popoverHandler == null) {
        popoverHandler = {
          options: {
            html: true,
            placement: "bottom",
            trigger: "manual",
            title: "Formula",
            container: editor.container
          },
          show: function(jqPopoverContainer, content, position) {
            jqPopoverContainer.css(position);
            popoverHandler.options.content = content;
            jqPopoverContainer.popover(popoverHandler.options);
            jqPopoverContainer.popover("show");
          },
          destroy: function(jqPopoverContainer) {
            return jqPopoverContainer.popover("destroy");
          },
          popoverExists: function(jqPopoverContainer) {
            var ref;
            return ((ref = jqPopoverContainer.data()) != null ? ref.popover : void 0) != null;
          },
          setContent: function(jqPopoverContainer, content) {
            var jqPopoverElement;
            return jqPopoverElement = jqPopoverContainer.data().popover.tip().children(".popover-content").html(content);
          },
          setPosition: function(jqPopoverContainer, position) {
            var jqPopoverElement;
            return jqPopoverElement = jqPopoverContainer.data().popover.tip().css(position);
          }
        };
      }
      initKaTeX = function(onLoaded) {
        var cssDemoPath, linkDemo, span;
        cssDemoPath = require.toUrl("./katex-demo.css");
        linkDemo = $("<link>").attr({
          rel: "stylesheet",
          href: cssDemoPath
        });
        $("head").append(linkDemo);
        span = $("<span>").attr({
          id: "formula"
        });
        $("body").append(span);
        require(["ace/ext/katex"], function(katexInner) {
          katex = katexInner;
          onLoaded();
        });
      };
      jqEditorContainer = $(editor.container);
      getFormulaElement = function() {
        return $("#formula");
      };
      KATEX_OPTIONS = {
        displayMode: true,
        throwOnError: false
      };
      TokenIterator = require("ace/token_iterator").TokenIterator;
      Range = require("ace/range").Range;
      erh = EquationRangeHandler = {
        BEGIN_EQUATION_TOKEN_SEQUENCE: [
          {
            type: "storage.type",
            value: "\\begin"
          }, {
            type: "lparen",
            value: "{"
          }, {
            type: "variable.parameter",
            value: "equation"
          }, {
            type: "rparen",
            value: "}"
          }
        ],
        END_EQUATION_TOKEN_SEQUENCE: [
          {
            type: "storage.type",
            value: "\\end"
          }, {
            type: "lparen",
            value: "{"
          }, {
            type: "variable.parameter",
            value: "equation"
          }, {
            type: "rparen",
            value: "}"
          }
        ],
        rangeCache: {},
        compareTokens: function(token1, token2) {
          return ((token1 == null) && (token2 == null)) || (token1 != null) && (token2 != null) && token1.type === token2.type && token1.value === token2.value;
        },
        getEquationStart: function(tokenIterator) {
          var curEquationStart, curSequenceIndex, curTokenPosition, i, len, ref, token;
          ref = erh.BEGIN_EQUATION_TOKEN_SEQUENCE;
          for (i = 0, len = ref.length; i < len; i++) {
            token = ref[i];
            if (erh.compareTokens(token, tokenIterator.getCurrentToken())) {
              tokenIterator.stepForward();
            }
          }
          curSequenceIndex = erh.BEGIN_EQUATION_TOKEN_SEQUENCE.length - 1;
          curEquationStart = null;
          while (curSequenceIndex >= 0) {
            if (erh.compareTokens(erh.BEGIN_EQUATION_TOKEN_SEQUENCE[curSequenceIndex], tokenIterator.stepBackward())) {
              if (curSequenceIndex === erh.BEGIN_EQUATION_TOKEN_SEQUENCE.length - 1) {
                curTokenPosition = tokenIterator.getCurrentTokenPosition();
                curEquationStart = {
                  row: curTokenPosition.row,
                  column: curTokenPosition.column + tokenIterator.getCurrentToken().value.length
                };
              }
              curSequenceIndex -= 1;
            } else {
              curSequenceIndex = erh.BEGIN_EQUATION_TOKEN_SEQUENCE.length - 1;
              curEquationStart = null;
            }
          }
          return curEquationStart;
        },
        getEquationEnd: function(tokenIterator) {
          var curEquationStart, curSequenceIndex, i, len, ref, token;
          ref = erh.END_EQUATION_TOKEN_SEQUENCE.slice(0).reverse();
          for (i = 0, len = ref.length; i < len; i++) {
            token = ref[i];
            if (erh.compareTokens(token, tokenIterator.getCurrentToken())) {
              tokenIterator.stepBackward();
            }
          }
          curSequenceIndex = 0;
          curEquationStart = null;
          while (curSequenceIndex < erh.END_EQUATION_TOKEN_SEQUENCE.length) {
            if (erh.compareTokens(erh.END_EQUATION_TOKEN_SEQUENCE[curSequenceIndex], tokenIterator.stepForward())) {
              if (curSequenceIndex === 0) {
                curEquationStart = tokenIterator.getCurrentTokenPosition();
              }
              curSequenceIndex += 1;
            } else {
              curSequenceIndex = 0;
              curEquationStart = null;
            }
          }
          return curEquationStart;
        },
        getEquationRange: function(row, column) {
          var end, start;
          start = erh.getEquationStart(new TokenIterator(editor.getSession(), row, column));
          end = erh.getEquationEnd(new TokenIterator(editor.getSession(), row, column));
          return new Range(start.row, start.column, end.row, end.column);
          return erh.rangeCache[[row, column]] = range;
        }
      };
      ch = ContextHandler = {
        contextPreviewExists: false,
        UPDATE_DELAY: 1000,
        getWholeEquation: function(range) {
          return editor.getSession().getTextRange(range);
        },
        getPopoverPosition: function(row) {
          return {
            top: (editor.renderer.textToScreenCoordinates(row + 2, 1).pageY) + "px",
            left: (jqEditorContainer.position().left) + "px"
          };
        },
        getCurrentFormula: function() {
          var e, error;
          try {
            return katex.renderToString(ch.getWholeEquation(ch.curRange), KATEX_OPTIONS);
          } catch (error) {
            e = error;
            return e;
          }
        },
        initPopover: function() {
          var popoverPosition;
          ch.updateRange();
          popoverPosition = ch.getPopoverPosition(ch.curRange.end.row);
          popoverHandler.show(getFormulaElement(), ch.getCurrentFormula(), popoverPosition);
          editor.on("change", ch.delayedUpdatePopover);
          return editor.getSession().on("changeScrollTop", ch.updatePosition);
        },
        updatePosition: function() {
          return popoverHandler.setPosition(getFormulaElement(), ch.getPopoverPosition(ch.curRange.end.row));
        },
        updateRange: function() {
          var cursorColumn, cursorRow, ref;
          ref = editor.getCursorPosition(), cursorRow = ref.row, cursorColumn = ref.column;
          return ch.curRange = erh.getEquationRange(cursorRow, cursorColumn);
        },
        updatePopover: function() {
          ch.updatePosition();
          return popoverHandler.setContent(getFormulaElement(), ch.getCurrentFormula());
        },
        updateCallback: function() {
          var curTime;
          if (ch.lastChangeTime != null) {
            curTime = Date.now();
            ch.currentDelayedUpdateId = setTimeout(ch.updateCallback, ch.UPDATE_DELAY - (Date.now() - ch.lastChangeTime));
            return ch.lastChangeTime = null;
          } else {
            ch.updatePopover();
            return ch.currentDelayedUpdateId = null;
          }
        },
        delayedUpdatePopover: function() {
          ch.updateRange();
          ch.updatePosition();
          if (ch.currentDelayedUpdateId != null) {
            ch.lastChangeTime = Date.now();
            return;
          }
          return ch.currentDelayedUpdateId = setTimeout(ch.updateCallback, ch.UPDATE_DELAY);
        },
        handleCurrentContext: function() {
          var currentContext, cursorColumn, cursorRow, ref;
          ref = editor.getCursorPosition(), cursorRow = ref.row, cursorColumn = ref.column;
          currentContext = LatexParsingContext.getContext(editor.getSession(), cursorRow);
          if (!ch.contextPreviewExists && currentContext === "equation") {
            ch.contextPreviewExists = true;
            if (katex == null) {
              return initKaTeX(ch.initPopover);
            } else {
              return ch.initPopover();
            }
          } else if ((ch.curRange != null) && !ch.curRange.contains(cursorRow, cursorColumn)) {
            ch.contextPreviewExists = false;
            editor.off("change", ch.delayedUpdatePopover);
            editor.getSession().off("changeScrollTop", ch.updatePosition);
            return popoverHandler.destroy(getFormulaElement());
          }
        }
      };
      sh = SelectionHandler = {
        hideSelectionPopover: function() {
          popoverHandler.destroy(getFormulaElement());
          editor.off("changeSelection", sh.hideSelectionPopover);
          editor.getSession().off("changeScrollTop", sh.hideSelectionPopover);
          editor.getSession().off("changeScrollLeft", sh.hideSelectionPopover);
        },
        renderSelectionUnderCursor: function() {
          var content, cursorColumn, cursorPosition, cursorRow, popoverPosition, ref;
          ref = editor.getCursorPosition(), cursorRow = ref.row, cursorColumn = ref.column;
          cursorPosition = editor.renderer.textToScreenCoordinates(cursorRow, cursorColumn);
          popoverPosition = {
            top: (cursorPosition.pageY + 24) + "px",
            left: cursorPosition.pageX + "px"
          };
          content = katex.renderToString(editor.getSelectedText(), KATEX_OPTIONS);
          popoverHandler.show(getFormulaElement(), content, popoverPosition);
          editor.on("changeSelection", sh.hideSelectionPopover);
          editor.getSession().on("changeScrollTop", sh.hideSelectionPopover);
          editor.getSession().on("changeScrollLeft", sh.hideSelectionPopover);
        },
        createPopover: function(editor) {
          if (!ch.contextPreviewExists) {
            if (katex == null) {
              initKaTeX(sh.renderSelectionUnderCursor);
              return;
            }
            return sh.renderSelectionUnderCursor();
          }
        }
      };
      editor.commands.addCommand({
        name: "previewLaTeXFormula",
        bindKey: {
          win: "Alt-p",
          mac: "Alt-p"
        },
        exec: SelectionHandler.createPopover
      });
      editor.on("changeSelection", ContextHandler.handleCurrentContext);
    };
  });

}).call(this);
