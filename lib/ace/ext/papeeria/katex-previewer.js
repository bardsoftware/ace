// Generated by CoffeeScript 1.10.0
(function() {
  define(function(require, exports, module) {
    exports.setupPreviewer = function(editor, popoverHandler) {
      var callback, callbackHidePopover, createPopover, destroyPopover, initKaTeX, katex, onLoaded;
      katex = null;
      popoverHandler = popoverHandler != null ? popoverHandler : {
        options: {
          html: true,
          placement: "bottom",
          trigger: "manual",
          title: "Formula",
          container: "#editor"
        },
        show: function(jqPopoverContainer, content) {
          var cursorPosition;
          cursorPosition = $("textarea.ace_text-input").position();
          jqPopoverContainer.css({
            top: (cursorPosition.top + 24) + "px",
            left: cursorPosition.left + "px"
          });
          popoverHandler.options.content = content;
          jqPopoverContainer.popover(popoverHandler.options);
          jqPopoverContainer.popover("show");
        },
        hide: function(jqPopoverContainer) {
          return jqPopoverContainer.popover("destroy");
        },
        isVisible: function(jqPopoverElement) {
          return jqPopoverElement.children(".popover").is(":visible");
        }
      };
      initKaTeX = function(onLoaded) {
        var cssDemoPath, linkDemo, span;
        cssDemoPath = require.toUrl("./katex-demo.css");
        linkDemo = $("<link>").attr({
          rel: "stylesheet",
          href: cssDemoPath
        });
        $("head").append(linkDemo);
        span = $("<span>").attr({
          id: "formula"
        });
        $("body").append(span);
        require(["ace/ext/katex"], function(katexInner) {
          katex = katexInner;
          onLoaded();
        });
      };
      callbackHidePopover = function() {
        popoverHandler.hide($("#formula"));
        editor.off("changeSelection", callbackHidePopover);
        editor.session.off("changeScrollTop", callbackHidePopover);
        editor.session.off("changeScrollLeft", callbackHidePopover);
      };
      onLoaded = function() {
        var content, e, error;
        try {
          return content = katex.renderToString(editor.getSelectedText(), {
            displayMode: true
          });
        } catch (error) {
          e = error;
          return content = e;
        } finally {
          popoverHandler.show($("#formula"), content);
          editor.on("changeSelection", callbackHidePopover);
          editor.session.on("changeScrollTop", callbackHidePopover);
          editor.session.on("changeScrollLeft", callbackHidePopover);
          return;
        }
      };
      callback = function(editor) {
        return createPopover(editor);
      };
      destroyPopover = function() {
        return popoverHandler.hide($("#formula"));
      };
      createPopover = function(editor) {
        if (katex == null) {
          initKaTeX(onLoaded);
          return;
        }
        return onLoaded();
      };
      editor.commands.addCommand({
        name: "previewLaTeXFormula",
        bindKey: {
          win: "Alt-p",
          mac: "Alt-p"
        },
        exec: callback
      });
    };
  });

}).call(this);
