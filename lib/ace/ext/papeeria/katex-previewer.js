// Generated by CoffeeScript 1.10.0
(function() {
  define(function(require, exports, module) {
    exports.setupPreviewer = function(editor) {
      var callback, createPopover, destroyPopover, initKaTeX, katex, onLoaded, options;
      katex = null;
      initKaTeX = function(onLoaded) {
        var a, cssDemoPath, linkDemo;
        cssDemoPath = require.toUrl("./katex-demo.css");
        linkDemo = $("<link>").attr({
          rel: "stylesheet",
          href: cssDemoPath
        });
        $("head").append(linkDemo);
        a = $("<a>").attr({
          href: "#",
          id: "formula",
          "data-toggle": "popover"
        });
        $("body").append(a);
        require(["ace/ext/katex"], function(katexInner) {
          katex = katexInner;
          onLoaded();
        });
      };
      options = {
        html: true,
        placement: "bottom",
        trigger: "manual",
        title: "Formula",
        container: "#editor"
      };
      onLoaded = function() {
        var e, error, popoverPosition;
        popoverPosition = $("textarea.ace_text-input").position();
        popoverPosition.top += 24;
        $("#formula").css(popoverPosition);
        try {
          options.content = katex.renderToString(editor.getSelectedText(), {
            displayMode: true
          });
        } catch (error) {
          e = error;
          options.content = e;
        } finally {
          $("#formula").popover(options);
          $("#formula").popover("show");
        }
      };
      callback = function(editor) {
        if ($("#editor > .popover").is(":visible")) {
          destroyPopover();
        } else {
          createPopover(editor);
        }
      };
      destroyPopover = function() {
        return $("#formula").popover("destroy");
      };
      createPopover = function(editor) {
        if (katex == null) {
          initKaTeX(onLoaded);
          return;
        }
        return onLoaded();
      };
      editor.commands.addCommand({
        name: "previewLaTeXFormula",
        bindKey: {
          win: "Alt-p",
          mac: "Alt-p"
        },
        exec: callback
      });
    };
  });

}).call(this);
