// Generated by CoffeeScript 1.10.0
(function() {
  define(function(require, exports, module) {
    exports.setupPreviewer = function(editor, popoverHandler) {
      var curEnd, curStart, editorContainer, getCurrentFormula, getEquationRange, getPopoverPosition, getTopmostRowNumber, getWholeEquation, handleCurrentContext, initKaTeX, initPopover, katex, prevContext, ref, updatePopover;
      katex = null;
      popoverHandler = popoverHandler != null ? popoverHandler : {
        options: {
          html: true,
          placement: "bottom",
          trigger: "manual",
          title: "Formula",
          container: editor.container
        },
        show: function(jqPopoverContainer, content, position) {
          jqPopoverContainer.css(position);
          popoverHandler.options.content = content;
          jqPopoverContainer.popover(popoverHandler.options);
          jqPopoverContainer.popover("show");
        },
        destroy: function(jqPopoverContainer) {
          return jqPopoverContainer.popover("destroy");
        },
        isVisible: function(jqPopoverContainer) {
          return jqPopoverContainer.data().popover.tip().hasClass("in");
        },
        popoverExists: function(jqPopoverContainer) {
          return (jqPopoverContainer.data() != null) && (jqPopoverContainer.data().popover != null);
        },
        setContent: function(jqPopoverContainer, content, position) {
          var jqPopoverElement;
          jqPopoverElement = jqPopoverContainer.data().popover.tip().children(".popover-content");
          return jqPopoverElement.html(content);
        }
      };
      initKaTeX = function(onLoaded) {
        var cssDemoPath, linkDemo, span;
        cssDemoPath = require.toUrl("./katex-demo.css");
        linkDemo = $("<link>").attr({
          rel: "stylesheet",
          href: cssDemoPath
        });
        $("head").append(linkDemo);
        span = $("<span>").attr({
          id: "formula"
        });
        $("body").append(span);
        require(["ace/ext/katex"], function(katexInner) {
          katex = katexInner;
          onLoaded();
        });
      };
      editorContainer = $(editor.container);
      ref = [null, null], curStart = ref[0], curEnd = ref[1];
      prevContext = editor.session.getContext(editor.getCursorPosition().row);
      getEquationRange = function(cursorRow) {
        var end, i, removeRegex, start, wholeEquation;
        i = cursorRow;
        removeRegex = /\\begin{equation}|\\label{.*}|\\begin{equation*}/g;
        while (editor.session.getContext(i - 1) === "equation") {
          i -= 1;
        }
        start = i;
        while (editor.session.getContext(i + 1) === "equation") {
          i += 1;
        }
        end = i;
        wholeEquation = editor.session.getLines(start, end).join(" ").replace(removeRegex, "");
        return [start, end];
      };
      getWholeEquation = function(start, end) {
        var removeRegex, wholeEquation;
        removeRegex = /\\begin\{equation\}|\\label\{[^\}]*\}/g;
        wholeEquation = editor.session.getLines(start, end).join(" ").replace(removeRegex, "");
        return wholeEquation;
      };
      getTopmostRowNumber = function() {
        return parseInt(editorContainer.find("div.ace_gutter > div.ace_layer.ace_gutter-layer.ace_folding-enabled > div:nth-child(1)").text());
      };
      getPopoverPosition = function(row) {
        var cursorRowPosition, gutter, left, rowSelector, top;
        rowSelector = "div.ace_scroller > div > div.ace_layer.ace_text-layer > div:nth-child(" + (row + 2 - getTopmostRowNumber()) + ")";
        console.log(rowSelector);
        cursorRowPosition = editorContainer.find(rowSelector).position();
        top = (cursorRowPosition.top + 24 + 8) + "px";
        gutter = editorContainer.find("div.ace_gutter > div.ace_layer.ace_gutter-layer.ace_folding-enabled");
        left = gutter.position().left + gutter.width() + 10;
        return {
          top: top,
          left: left
        };
      };
      getCurrentFormula = function() {
        return katex.renderToString(getWholeEquation(curStart, curEnd), {
          displayMode: true
        });
      };
      initPopover = function() {
        var content, cursorRow, e, error, popoverPosition, ref1;
        cursorRow = editor.getCursorPosition().row;
        ref1 = getEquationRange(cursorRow), curStart = ref1[0], curEnd = ref1[1];
        popoverPosition = getPopoverPosition(curEnd);
        try {
          return content = getCurrentFormula();
        } catch (error) {
          e = error;
          return content = e;
        } finally {
          popoverHandler.show($("#formula"), content, popoverPosition);
        }
      };
      updatePopover = function() {
        var content, cursorRow, e, error;
        console.log("heyooo");
        cursorRow = editor.getCursorPosition().row;
        try {
          return content = getCurrentFormula();
        } catch (error) {
          e = error;
          return content = e;
        } finally {
          popoverHandler.setContent($("#formula"), content);
        }
      };
      handleCurrentContext = function() {
        var currentContext;
        currentContext = editor.session.getContext(editor.getCursorPosition().row);
        if (prevContext !== "equation" && currentContext === "equation") {
          if (katex == null) {
            initKaTeX(initPopover);
          } else {
            initPopover();
          }
          editor.on("change", updatePopover);
        } else if (prevContext === "equation" && currentContext !== "equation") {
          editor.off("change", updatePopover);
          popoverHandler.destroy($("#formula"));
        }
        return prevContext = currentContext;
      };
      return editor.on("changeSelection", handleCurrentContext);
    };
  });

}).call(this);
