<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Editor</title>
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/2.3.2/css/bootstrap.min.css">
  <style type="text/css" media="screen">
    body {
        overflow: hidden;
    }
    #editor {
        margin: 0;
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
    }
    .typo {
      border-bottom: 1px dotted red;
    }
    .ace_marker-layer .typo {
      position: absolute;
      z-index: 1;
    }
    #highlightInfo {
      width: 0;
      height: 0;
      text-align: center;
      font-size: 1.5em;
      margin: 0;
      position: absolute;
      top: 0;
      right: 0.4cm;
      z-index: 1;
    }
    #formula {
        width: 0;
        height: 0;
        text-align: center;
        font-size: 1.5em;
        margin: 0;
        position: absolute;
        top: 0;
        right: 0.4cm;
        z-index: 1;
    }
    .popover {
        max-width: 100%;
    }
  </style>
</head>
<body>
<pre id="editor">
$xxx$
\length
blablabla
bla

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Journal Article
% LaTeX Template
% Version 1.3 (9/9/13)
%
% This template has been downloaded from:
% http://www.LaTeXTemplates.com
%
% Original author:
% Frits Wenneker (http://www.howtotex.com)
%
% License:
% CC BY-NC-SA 3.0 (http://creativecommons.org/licenses/by-nc-sa/3.0/)
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%----------------------------------------------------------------------------------------
% PACKAGES AND OTHER DOCUMENT CONFIGURATIONS
%----------------------------------------------------------------------------------------

\documentclass[twoside]{article}

\usepackage{lipsum} % Package to generate dummy text throughout this template

\usepackage[sc]{mathpazo} % Use the Palatino font
\usepackage[T1]{fontenc} % Use 8-bit encoding that has 256 glyphs
\linespread{1.05} % Line spacing - Palatino needs more space between lines
\usepackage{microtype} % Slightly tweak font spacing for aesthetics

\usepackage[hmarginratio=1:1,top=32mm,columnsep=20pt]{geometry} % Document margins
\usepackage{multicol} % Used for the two-column layout of the document
\usepackage[hang, small,labelfont=bf,up,textfont=it,up]{caption} % Custom captions under/above floats in tables or figures
\usepackage{booktabs} % Horizontal rules in tables
\usepackage{float} % Required for tables and figures in the multi-column environment - they need to be placed in specific locations with the [H] (e.g. \begin{table}[H])
\usepackage{hyperref} % For hyperlinks in the PDF

\usepackage{lettrine} % The lettrine is the first enlarged letter at the beginning of the text
\usepackage{paralist} % Used for the compactitem environment which makes bullet points with less space between them

\usepackage{abstract} % Allows abstract customization
\renewcommand{\abstractnamefont}{\normalfont\bfseries} % Set the "Abstract" text to bold
\renewcommand{\abstracttextfont}{\normalfont\small\itshape} % Set the abstract itself to small italic text

\usepackage{titlesec} % Allows customization of titles
\renewcommand\thesection{\Roman{section}} % Roman numerals for the sections
\renewcommand\thesubsection{\Roman{subsection}} % Roman numerals for subsections
\titleformat{\section}[block]{\large\scshape\centering}{\thesection.}{1em}{} % Change the look of the section titles
\titleformat{\subsection}[block]{\large}{\thesubsection.}{1em}{} % Change the look of the section titles

\usepackage{fancyhdr} % Headers and footers
\pagestyle{fancy} % All pages have headers and footers
\fancyhead{} % Blank out the default header
\fancyfoot{} % Blank out the default footer
\fancyhead[C]{Running title $\bullet$ November 2012 $\bullet$ Vol. XXI, No. 1} % Custom header text
\fancyfoot[RO,LE]{\thepage} % Custom footer text

%----------------------------------------------------------------------------------------
% TITLE SECTION
%----------------------------------------------------------------------------------------

\title{\vspace{-15mm}\fontsize{24pt}{10pt}\selectfont\textbf{Article Title}} % Article title

\author{
\large
\textsc{John Smith}\thanks{A thank you or further information}\\[2mm] % Your name
\normalsize University of California \\ % Your institution
\normalsize \href{mailto:john@smith.com}{john@smith.com} % Your email address
\vspace{-5mm}
}
\date{}

%----------------------------------------------------------------------------------------

\begin{document}

\maketitle % Insert title

\thispagestyle{fancy} % All pages have headers and footers

%----------------------------------------------------------------------------------------
% ABSTRACT
%----------------------------------------------------------------------------------------

\begin{abstract}

\noindent \lipsum[1] % Dummy abstract text

\end{abstract}

%----------------------------------------------------------------------------------------
% ARTICLE CONTENTS
%----------------------------------------------------------------------------------------

\begin{multicols}{2} % Two-column layout throughout the main article text

\section{Introduction}

\lettrine[nindent=0em,lines=3]{L} orem ipsum dolor sit amet, consectetur adipiscing elit.
\lipsum[2-3] % Dummy text

%------------------------------------------------

\section{Methods}

Maecenas sed ultricies felis. Sed imperdiet dictum arcu a egestas.
\begin{compactitem}
\item Donec dolor arcu, rutrum id molestie in, viverra sed diam
\item Curabitur feugiat
\item turpis sed auctor facilisis
\item arcu eros accumsan lorem, at posuere mi diam sit amet tortor
\item Fusce fermentum, mi sit amet euismod rutrum
\item sem lorem molestie diam, iaculis aliquet sapien tortor non nisi
\item Pellentesque bibendum pretium aliquet
\end{compactitem}
\lipsum[4] % Dummy text

%------------------------------------------------

\section{Results}

\begin{table}[H]
\caption{Example table}
\centering
\begin{tabular}{llr}
\toprule
\multicolumn{2}{c}{Name} \\
\cmidrule(r){1-2}
First name & Last Name & Grade \\
\midrule
John & Doe & $7.5$ \\
Richard & Miles & $2$ \\
\bottomrule
\end{tabular}
\end{table}

\lipsum[5] % Dummy text

\[\alpha\]

$x^2$

$\beta$

$$\gamma$$

\begin{equation}
\label{eq:emc}
\label{notemc}
\text{here's a formula! }
\sum_{n=1}^{N} \gamma(z_{np}) \frac {\mathcal{N} (x_n | \mu_{ pt }, \Sigma_{pt})} {\sum_l \pi_{pl} \mathcal{N} (x_n | \mu_{pl}, \Sigma_{pl})}
+ \frac{\alpha_{pt} - 1}{\pi_{pt}} = \sum_{n=1}^{N} \gamma(z_{np}) + \sum_{l=1}^{L} (\alpha_{pl} - 1) \sum_{n=1}^{N} \gamma(z_{np})
\frac {\pi_{pt} \mathcal{N} (x_n | \mu_{ pt }, \Sigma_{pt})} {\sum_l \pi_{pl} \mathcal{N} (x_n | \mu_{pl}, \Sigma_{pl})} + \alpha_{pt} - 1 =
\pi_{pt} \Big(\sum_{n=1}^{N} \gamma(z_{np}) + \sum_{l=1}^{L} (\alpha_{pl} - 1)\Big) \frac{\sum_{n=1}^{N} \gamma(z_{np})
\frac {\pi_{pt} \mathcal{N} (x_n | \mu_{ pt }, \Sigma_{pt})} {\sum_l \pi_{pl} \mathcal{N} (x_n | \mu_{pl}, \Sigma_{pl})} +
\alpha_{pt} - 1} { \sum_{n=1}^{N} \gamma(z_{np}) + \sum_{l=1}^{L} (\alpha_{pl} - 1)} = \pi_{pt}

\end{equation}

\begin{equation*}
    \text{hello}
\end{equation*}

\lipsum[6] % Dummy text

%------------------------------------------------

\section{Discussion}

\subsection{Subsection One}

\lipsum[7] % Dummy text

\subsection{Subsection Two}

\lipsum[8] % Dummy text

%----------------------------------------------------------------------------------------
% REFERENCE LIST
%----------------------------------------------------------------------------------------

\begin{thebibliography}{99} % Bibliography - this is intentionally simple in this template

\bibitem[Figueredo and Wolf, 2009]{Figueredo:2009dg}
Figueredo, A.~J. and Wolf, P. S.~A. (2009).
\newblock Assortative pairing and life history strategy - a cross-cultural
  study.
\newblock {\em Human Nature}, 20:317--330.

\end{thebibliography}

%----------------------------------------------------------------------------------------

\end{multicols}

\end{document}</pre>

<script src="kitchen-sink/require.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/2.3.2/js/bootstrap.min.js"></script>

<script>
require.config({ paths : { "ace" : "../lib/ace" } });
require([
  "ace/ace",
  "ace/ext/language_tools",
  "ace/ext/papeeria/katex-previewer",
  "ace/ext/papeeria/highlighter",
  "ace/ext/papeeria/tex_completer",
  "ace/ext/papeeria/spellchecker",
  "ace/ext/papeeria/spellchecker_popup"
  ],
  function(ace, langTools, katexPreviewer, highlighter, TexCompleter, Spellchecker, SpellcheckerPopup) {
    var editor = ace.edit("editor");
    editor.$blockScrolling = Infinity;
    var session = editor.getSession();
    session.setMode("ace/mode/papeeria_latex");
    session.setUseWorker(true);

    // SpellcheckerPopup.setup(editor);
    // Spellchecker.setup(editor);

    // session.on("changeMode", function() {
    //   Spellchecker.getInstance().onSessionUpdated(
    //     "http://localhost:8000/typos.json",
    //     "http://localhost:8000/corrections.json"
    //   );
    //   Spellchecker.getInstance().onHashUpdated("sedf43f9ufuahf4938hf");
    //   Spellchecker.getInstance().onSettingsUpdated({
    //     alphabet: 'abcdefghijklmnopqrstuvwxyz',
    //     enabled: true,
    //     language: "en_US",
    //     onSettingsUpdateSuccess: function() {},
    //     onSettingsUpdateError: function(data) {
    //       console.log("Error: " + data.content);
    //     }
    //   });
    // });

    editor.setOptions({
        enableBasicAutocompletion: true,
        enableSnippets: true,
        enableLiveAutocompletion: true
    });

    candidateToggleSurroundingBracketsPopup = function(editor, posLeft, posRight) {
      var content, options, session;
      session = editor.getSession();
      if (posLeft && posRight) {
        if (posRight.row > editor.getLastVisibleRow() || posLeft.row < editor.getFirstVisibleRow()) {
          content = "line " + (posLeft.row + 1) + ": " + session.getLine(posLeft.row) + "    line " + (posRight.row + 1) + ": " + session.getLine(posRight.row);
          options = {
            html: true,
            placement: "bottom",
            trigger: "manual",
            container: "#editor",
            content: content
          };
          setTimeout(function() {
            var cursorPosition;
            cursorPosition = $("textarea.ace_text-input").position();
            $("#highlightInfo").css({
              top: cursorPosition.top + 24 + "px",
              left: cursorPosition.left + "px"
            });
            $("#highlightInfo").popover(options);
            $("#highlightInfo").popover("show");
          }, 100);
        }
        return;
      }
      $("#highlightInfo").popover("destroy");
    };

    var texCompleter = new TexCompleter();
    texCompleter.init(editor);
    langTools.addCompleter(texCompleter);
    texCompleter.setReferencesUrl("/demo/example.json")
    texCompleter.setCitationsUrl("/demo/biblio.json")

    console.log("Simple Latex Completer successfully added");
    //Initialization bind for highlight brackets.
    highlighter.init(ace, editor, {win: 'Ctrl-Shift-9', mac: 'Command-Shift-9'}, candidateToggleSurroundingBracketsPopup);
    langTools.snippetCompleter.getDocTooltip = null;

    var jqPopoverContainer = $("#formula");

    var popoverHandler = {
        options: {
            html: true,
            placement: "bottom",
            trigger: "manual",
            container: editor.container
        },
        show: function(title, content, position) {
            jqPopoverContainer.css(position);
            popoverHandler.options.content = content;
            popoverHandler.options.title = title;
            jqPopoverContainer.popover(popoverHandler.options);
            jqPopoverContainer.popover("show");
        },
        destroy: function() {
            return jqPopoverContainer.popover("destroy");
        },
        popoverExists: function() {
            var ref;
            return ((ref = jqPopoverContainer.data()) != null ? ref.popover : void 0) != null;
        },
        setContent: function(title, content) {
            var popoverElement;
            popoverElement = jqPopoverContainer.data().popover.tip();
            popoverElement.children(".popover-content").html(content);
            return popoverElement.children(".popover-title").text(title);
        },
        setPosition: function(position) {
            return jqPopoverContainer.data().popover.tip().css(position);
        }
    };

    var messageMap = {
        "js.math_preview.error.document_end": "Error: end of the document reached",
        "js.math_preview.error.empty_line": "Error: empty line reached",
        "js.math_preview.error.whitespace_line": "Error: line of whitespaces reached"
    };

    var I18N = {
        text: function(code) {
            var ref;
            return (ref = messageMap[code]) != null ? ref : code;
        }
    };

    console.log(katexPreviewer);

    katexPreviewer.setupPreviewer(editor, popoverHandler, null, I18N);
    window.loadCss = function(cssShortName) {
      var baseUrl = "../lib/ace/ext/" + cssShortName + "/";
      var link = $("<link>").attr({
        rel: "stylesheet",
        href: baseUrl + cssShortName + ".min.css"
      });
      $("head").append(link);
    }
});
</script>
<span id = "highlightInfo"></span>
<span id="formula"><span>

</body>
</html>
